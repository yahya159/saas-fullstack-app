<div class="modal-overlay" *ngIf="isOpen()" (click)="close()" (keydown)="onKeyDown($event)">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <h2>Create New Feature</h2>
      <button class="modal-close" (click)="close()" aria-label="Close modal">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <form [formGroup]="featureForm" (ngSubmit)="createFeature()">
        <!-- Feature Key -->
        <div class="form-group">
          <label for="feature-key">Feature Key *</label>
          <input
            id="feature-key"
            type="text"
            formControlName="key"
            placeholder="e.g., api.limit, custom.domain"
            class="form-input"
            [class.error]="getFieldError('key')"
          />
          <div class="field-error" *ngIf="getFieldError('key')">
            {{ getFieldError('key') }}
          </div>
          <div class="field-help">
            Used internally to identify the feature. Only lowercase letters, numbers, and dots allowed.
          </div>
        </div>

        <!-- Feature Name -->
        <div class="form-group">
          <label for="feature-name">Feature Name *</label>
          <input
            id="feature-name"
            type="text"
            formControlName="name"
            placeholder="e.g., API Rate Limit, Custom Domain"
            class="form-input"
            [class.error]="getFieldError('name')"
          />
          <div class="field-error" *ngIf="getFieldError('name')">
            {{ getFieldError('name') }}
          </div>
          <div class="field-help">
            Display name shown to users in the pricing widget.
          </div>
        </div>

        <!-- Feature Description -->
        <div class="form-group">
          <label for="feature-description">Description</label>
          <textarea
            id="feature-description"
            formControlName="description"
            placeholder="Describe what this feature does..."
            class="form-textarea"
            rows="3"
          ></textarea>
          <div class="field-help">
            Optional description to help users understand the feature.
          </div>
        </div>

        <!-- Category Selection -->
        <div class="form-group">
          <label for="feature-category">Category</label>
          <select
            id="feature-category"
            formControlName="categoryId"
            class="form-select"
          >
            <option value="">No Category</option>
            <option *ngFor="let category of categories$ | async" [value]="category.id">
              {{ category.name }}
            </option>
          </select>
          <div class="field-help">
            Group this feature with others in the same category.
          </div>
        </div>

        <!-- Tier Visibility -->
        <div class="form-group">
          <label>Tier Visibility</label>
          <div class="tier-visibility">
            <div *ngFor="let tier of availableTiers()" class="tier-checkbox">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [formControlName]="'tier' + tier.key.charAt(0).toUpperCase() + tier.key.slice(1)"
                  class="checkbox-input"
                />
                <span class="checkbox-custom"></span>
                <div class="checkbox-content">
                  <span class="tier-name">{{ tier.label }}</span>
                  <span class="tier-description">{{ tier.description }}</span>
                </div>
              </label>
            </div>
          </div>
          <div class="field-help">
            Select which pricing tiers can use this feature.
          </div>
        </div>

        <!-- Enabled by Default -->
        <div class="form-group">
          <label class="checkbox-label">
            <input
              type="checkbox"
              formControlName="enabledByDefault"
              class="checkbox-input"
            />
            <span class="checkbox-custom"></span>
            <span class="checkbox-text">Enabled by default</span>
          </label>
          <div class="field-help">
            This feature will be enabled by default in all plans.
          </div>
        </div>

        <!-- Error Display -->
        <div class="form-error" *ngIf="error()">
          <div class="error-content">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 1a7 7 0 100 14A7 7 0 008 1zm0 12a5 5 0 110-10 5 5 0 010 10z"/>
              <path d="M8 4a4 4 0 100 8 4 4 0 000-8z"/>
            </svg>
            {{ error() }}
          </div>
        </div>
      </form>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button
        type="button"
        class="btn btn-outline"
        (click)="close()"
        [disabled]="isLoading()"
      >
        Cancel
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="createFeature()"
        [disabled]="!isFormValid() || isLoading()"
      >
        <span *ngIf="isLoading()" class="loading-spinner"></span>
        {{ isLoading() ? 'Creating...' : 'Create Feature' }}
      </button>
    </div>
  </div>
</div>
