<div class="widgets-export-container">
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1>Widget Export Manager</h1>
      <p>Manage and export pricing widgets for external integration</p>
    </div>
    <div class="header-actions">
      <button
        class="btn btn-secondary"
        (click)="refreshWidgets()"
        title="Refresh widgets">
        <i class="pi pi-refresh"></i>
        Refresh
      </button>
      <button
        class="btn btn-primary"
        (click)="openExportDialog()"
        [disabled]="getAvailableWidgetsForExport().length === 0">
        <i class="pi pi-upload"></i>
        Export Widget
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="search-container">
      <i class="pi pi-search search-icon"></i>
      <input
        type="text"
        class="search-input"
        placeholder="Search widgets..."
        [(ngModel)]="searchQuery"
        (ngModelChange)="searchQuery.set($event)">
    </div>

    <div class="filter-toggles">
      <label class="filter-toggle">
        <input
          type="checkbox"
          [(ngModel)]="showOnlyPublic"
          (ngModelChange)="showOnlyPublic.set($event)">
        <span>Public only</span>
      </label>
      <label class="filter-toggle">
        <input
          type="checkbox"
          [(ngModel)]="showOnlyActive"
          (ngModelChange)="showOnlyActive.set($event)">
        <span>Active only</span>
      </label>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="loading-state">
    <i class="pi pi-spinner pi-spin"></i>
    <span>Loading exported widgets...</span>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading() && getFilteredWidgets().length === 0" class="empty-state">
    <i class="pi pi-cloud-upload"></i>
    <h3>No exported widgets found</h3>
    <p *ngIf="exportableWidgets().length === 0">
      You haven't exported any widgets yet. Export a widget to make it available for external integration.
    </p>
    <p *ngIf="exportableWidgets().length > 0">
      No widgets match your current filters.
    </p>
    <button
      *ngIf="getAvailableWidgetsForExport().length > 0"
      class="btn btn-primary"
      (click)="openExportDialog()">
      Export Your First Widget
    </button>
  </div>

  <!-- Widgets Grid -->
  <div *ngIf="!loading() && getFilteredWidgets().length > 0" class="widgets-grid">
    <div *ngFor="let widget of getFilteredWidgets()" class="widget-card">
      <!-- Widget Header -->
      <div class="widget-header">
        <div class="widget-info">
          <h3 class="widget-name">{{ widget.name }}</h3>
          <p *ngIf="widget.description" class="widget-description">{{ widget.description }}</p>
        </div>
        <div class="widget-status">
          <span [class]="'status-badge ' + getStatusBadgeClass(widget)">
            {{ getStatusText(widget) }}
          </span>
        </div>
      </div>

      <!-- Widget Meta -->
      <div class="widget-meta">
        <div class="meta-item">
          <i class="pi pi-calendar"></i>
          <span>Created: {{ widget.createdAt | date:'short' }}</span>
        </div>
        <div class="meta-item">
          <i class="pi pi-clock"></i>
          <span>Updated: {{ widget.updatedAt | date:'short' }}</span>
        </div>
      </div>

      <!-- Widget Actions -->
      <div class="widget-actions">
        <div class="primary-actions">
          <button
            class="btn btn-sm btn-outline"
            (click)="showEmbedCode(widget)"
            title="Get embed code">
            <i class="pi pi-code"></i>
            Embed Code
          </button>
          <button
            class="btn btn-sm btn-outline"
            (click)="previewWidget(widget)"
            title="Preview widget">
            <i class="pi pi-eye"></i>
            Preview
          </button>
          <button
            class="btn btn-sm btn-secondary"
            (click)="editWidget(widget)"
            title="Edit widget">
            <i class="pi pi-pencil"></i>
            Edit
          </button>
        </div>

        <div class="toggle-actions">
          <button
            class="btn btn-sm toggle-btn"
            [class.active]="widget.isPublic"
            (click)="toggleWidgetPublic(widget)"
            [title]="widget.isPublic ? 'Make private' : 'Make public'">
            <i [class]="widget.isPublic ? 'pi pi-globe' : 'pi pi-lock'"></i>
            {{ widget.isPublic ? 'Public' : 'Private' }}
          </button>
          <button
            class="btn btn-sm toggle-btn"
            [class.active]="widget.isActive"
            (click)="toggleWidgetActive(widget)"
            [title]="widget.isActive ? 'Deactivate' : 'Activate'">
            <i [class]="widget.isActive ? 'pi pi-check-circle' : 'pi pi-times-circle'"></i>
            {{ widget.isActive ? 'Active' : 'Inactive' }}
          </button>
        </div>

        <button
          class="btn btn-sm btn-danger"
          (click)="deleteExportedWidget(widget)"
          title="Remove from exports">
          <i class="pi pi-trash"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Export Dialog -->
  <div *ngIf="showExportDialog()" class="modal-overlay" (click)="closeExportDialog()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Export Widget</h3>
        <button class="btn btn-sm btn-ghost" (click)="closeExportDialog()">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div *ngIf="getAvailableWidgetsForExport().length === 0" class="no-widgets-message">
          <p>All your widgets have already been exported.</p>
          <p>Create new widgets in the Widget Builder to export them.</p>
        </div>

        <div *ngIf="getAvailableWidgetsForExport().length > 0">
          <p>Select a widget to export for external integration:</p>
          <div class="widget-selection">
            <label
              *ngFor="let widget of getAvailableWidgetsForExport()"
              class="widget-option">
              <input
                type="radio"
                name="selectedWidget"
                [value]="widget.id"
                (change)="selectedWidgetForExport.set(widget)">
              <span class="widget-option-content">
                <strong>{{ widget.name }}</strong>
                <small>Template: {{ widget.templateId || 'Custom' }}</small>
              </span>
            </label>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button
          class="btn btn-primary"
          [disabled]="!selectedWidgetForExport() || getAvailableWidgetsForExport().length === 0"
          (click)="exportWidget()">
          Export Widget
        </button>
        <button
          class="btn btn-secondary"
          (click)="closeExportDialog()">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Embed Code Dialog -->
  <div *ngIf="showEmbedCodeDialog()" class="modal-overlay" (click)="closeEmbedCodeDialog()">
    <div class="modal-dialog modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Embed Code - {{ selectedWidget()?.name }}</h3>
        <button class="btn btn-sm btn-ghost" (click)="closeEmbedCodeDialog()">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="embed-instructions">
          <h4>Integration Instructions</h4>
          <ol>
            <li>Copy the embed code below</li>
            <li>Paste it into your website's HTML where you want the widget to appear</li>
            <li>The widget will automatically load and display your pricing</li>
          </ol>
        </div>

        <div class="code-section">
          <div class="code-header">
            <span>Embed Code</span>
            <button class="btn btn-sm btn-outline" (click)="copyEmbedCode()">
              <i class="pi pi-copy"></i>
              Copy Code
            </button>
          </div>
          <textarea
            class="code-textarea"
            readonly
            [value]="embedCode()"
            rows="12">
          </textarea>
        </div>

        <div class="additional-info">
          <h5>Additional Resources</h5>
          <div class="resource-links">
            <a [href]="selectedWidget()?.previewUrl" target="_blank" class="resource-link">
              <i class="pi pi-eye"></i>
              Preview Widget
            </a>
            <a [href]="selectedWidget()?.configUrl" target="_blank" class="resource-link">
              <i class="pi pi-cog"></i>
              Widget Configuration
            </a>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeEmbedCodeDialog()">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
