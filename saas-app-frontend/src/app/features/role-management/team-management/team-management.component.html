<div class="team-management">
  <div class="page-header">
    <div class="header-content">
      <h1>Team Management & Role-Based Access Control</h1>
      <p class="subtitle">Manage user roles and permissions based on the organizational architecture</p>
    </div>

    <div class="header-actions">
      <button class="btn btn-primary" (click)="showAssignRoleModal = true">
        <svg class="btn-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
        </svg>
        Assign Role
      </button>
      <button class="btn btn-outline" (click)="loadData()">
        <svg class="btn-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
        </svg>
        Refresh
      </button>
    </div>
  </div>

  <!-- Role Categories -->
  <div class="role-categories">
    <div class="section-header">
      <h2>Role Architecture Overview</h2>
      <span class="section-badge">Organizational Structure</span>
    </div>

    <div class="provider-roles">
      <div class="roles-section-header">
        <div class="section-icon provider">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 13h6c0-1.42.61-2.68 1.58-3.55L12 8l-1.05-1.18C9.68 8.09 9 9.37 9 11v2H4c-1.1 0-2-.9-2-2V9c0-1.1.9-2 2-2h5c1.1 0 2 .9 2 2v2zm8-2h7c1.1 0 2 .9 2 2v2c0 1.1-.9 2-2 2h-5v-2c0-1.63-.67-2.91-1.58-3.82L12 11z"/>
          </svg>
        </div>
        <div>
          <h3>Provider Side (Our Organization)</h3>
          <p class="section-description">Internal platform management and administrative roles</p>
        </div>
      </div>

      <div class="roles-grid">
        <div class="role-card provider-role" *ngFor="let role of providerRoles()">
          <div class="role-header">
            <div class="role-avatar provider">
              {{ getRoleInfo(role.roleType).icon }}
            </div>
            <div class="role-title">
              <h4>{{ role.name }}</h4>
              <span class="role-type">{{ getRoleInfo(role.roleType).displayName }}</span>
            </div>
          </div>

          <p class="role-description">{{ role.description }}</p>

          <div class="responsibilities">
            <h5>Key Responsibilities:</h5>
            <ul class="responsibility-list">
              <li *ngFor="let responsibility of role.responsibilities.slice(0, 3)">
                {{ responsibility }}
              </li>
              <li *ngIf="role.responsibilities.length > 3" class="more-items">
                +{{ role.responsibilities.length - 3 }} more responsibilities...
              </li>
            </ul>
          </div>

          <div class="permissions-summary">
            <span class="permission-badge" *ngFor="let perm of getTopPermissions(role.permissions)">
              {{ perm }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="client-roles">
      <div class="roles-section-header">
        <div class="section-icon client">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
        </div>
        <div>
          <h3>Client Side (User Organizations)</h3>
          <p class="section-description">Customer organization roles and permissions</p>
        </div>
      </div>

      <div class="roles-grid">
        <div class="role-card client-role" *ngFor="let role of clientRoles()">
          <div class="role-header">
            <div class="role-avatar client">
              {{ getRoleInfo(role.roleType).icon }}
            </div>
            <div class="role-title">
              <h4>{{ role.name }}</h4>
              <span class="role-type">{{ getRoleInfo(role.roleType).displayName }}</span>
            </div>
          </div>

          <div class="profile-suggestion">
            <strong>Typical Profiles:</strong> {{ getRoleInfo(role.roleType).profileSuggestion }}
          </div>

          <p class="role-description">{{ role.description }}</p>

          <div class="responsibilities">
            <h5>Key Responsibilities:</h5>
            <ul class="responsibility-list">
              <li *ngFor="let responsibility of role.responsibilities.slice(0, 3)">
                {{ responsibility }}
              </li>
            </ul>
          </div>

          <div class="permissions-summary">
            <span class="permission-badge" *ngFor="let perm of getTopPermissions(role.permissions)">
              {{ perm }}
            </span>
          </div>

          <div class="role-actions">
            <button class="btn btn-sm btn-primary" (click)="selectRoleForAssignment(role)">
              <svg class="btn-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 0a8 8 0 100 16A8 8 0 008 0zM4 7a1 1 0 012 0v2h2a1 1 0 110 2H6v2a1 1 0 11-2 0v-2H2a1 1 0 110-2h2V7z"/>
              </svg>
              Assign
            </button>
            <button class="btn btn-sm btn-outline" (click)="viewRoleDetails(role)">
              <svg class="btn-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"/>
              </svg>
              Details
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Current Team Assignments -->
  <div class="team-assignments" *ngIf="getTotalUserRolesCount() > 0">
    <div class="section-header">
      <h2>Current Team Assignments</h2>
      <div class="assignment-stats">
        <span class="stat-badge active">
          {{ getActiveUserRolesCount() }} Active
        </span>
        <span class="stat-badge total">
          {{ getTotalUserRolesCount() }} Total
        </span>
      </div>
    </div>

    <div class="assignments-table">
      <div class="table-header">
        <div class="col-user">User</div>
        <div class="col-role">Role</div>
        <div class="col-application">Application</div>
        <div class="col-assigned">Assigned</div>
        <div class="col-actions">Actions</div>
      </div>

      <div class="table-row" *ngFor="let userRole of getUserRolesArray()">
        <div class="col-user">
          <div class="user-info">
            <div class="user-avatar">{{ getUserInitials(userRole.user) }}</div>
            <div class="user-details">
              <div class="user-name">{{ userRole.user }}</div>
              <div class="user-status" [class]="'status-' + (userRole.isActive ? 'active' : 'inactive')">
                <span class="status-dot"></span>
                {{ userRole.isActive ? 'Active' : 'Inactive' }}
              </div>
            </div>
          </div>
        </div>

        <div class="col-role">
          <div class="role-badge"
               [style.background-color]="getRoleInfo(userRole.role.roleType).color + '15'"
               [style.border-color]="getRoleInfo(userRole.role.roleType).color"
               [style.color]="getRoleInfo(userRole.role.roleType).color">
            <span class="role-icon">{{ getRoleInfo(userRole.role.roleType).icon }}</span>
            {{ userRole.role.name }}
          </div>
        </div>

        <div class="col-application">
          <span class="application-name">{{ userRole.application }}</span>
        </div>

        <div class="col-assigned">
          <time class="assigned-date" [dateTime]="userRole.assignedAt">
            {{ formatDate(userRole.assignedAt) }}
          </time>
        </div>

        <div class="col-actions">
          <div class="action-buttons">
            <button class="btn btn-sm btn-ghost" (click)="editUserRole(userRole)" title="Edit role assignment">
              <svg class="btn-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M13.498.795l.149-.149a1.207 1.207 0 111.707 1.708l-.149.148a1.5 1.5 0 01-.059 2.059L4.854 14.854a.5.5 0 01-.233.131l-4 1a.5.5 0 01-.606-.606l1-4a.5.5 0 01.131-.232l9.642-9.642a.5.5 0 00-.642.056L6.854 4.854a.5.5 0 11-.708-.708L9.44.854A1.5 1.5 0 0111.5.796a1.5 1.5 0 011.998-.001z"/>
              </svg>
            </button>
            <button class="btn btn-sm btn-danger" (click)="revokeUserRole(userRole)" title="Revoke role">
              <svg class="btn-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L8 6.586l2.293-2.293a1 1 0 111.414 1.414L9.414 8l2.293 2.293a1 1 0 01-1.414 1.414L8 9.414l-2.293 2.293a1 1 0 01-1.414-1.414L6.586 8 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="getTotalUserRolesCount() === 0">
    <div class="empty-content">
      <div class="empty-icon">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
      </div>
      <h3>No Team Members Yet</h3>
      <p>Start building your team by assigning roles to users based on their organizational profiles and responsibilities.</p>
      <button class="btn btn-primary btn-lg" (click)="showAssignRoleModal = true">
        <svg class="btn-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
        </svg>
        Assign First Role
      </button>
    </div>
  </div>
</div>

<!-- Assign Role Modal -->
<div class="modal-overlay" *ngIf="showAssignRoleModal" (click)="closeAssignModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">
        <h3>Assign User Role</h3>
        <p class="modal-subtitle">Configure role-based access for team members</p>
      </div>
      <button class="close-btn" (click)="closeAssignModal()" aria-label="Close modal">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
    </div>

    <form [formGroup]="assignRoleForm" (ngSubmit)="assignRole()" class="modal-body">
      <div class="form-group">
        <label for="userId" class="form-label">
          User ID
          <span class="required">*</span>
        </label>
        <input
          id="userId"
          type="text"
          formControlName="userId"
          placeholder="Enter user ID or email"
          class="form-control">
        <p class="form-hint">Enter the unique identifier for the user</p>
      </div>

      <div class="form-group">
        <label for="roleId" class="form-label">
          Role Assignment
          <span class="required">*</span>
        </label>
        <select id="roleId" formControlName="roleId" class="form-control">
          <option value="">Select a role</option>
          <optgroup label="Client Roles (Recommended)">
            <option *ngFor="let role of getClientRoles()" [value]="role._id">
              {{ getRoleInfo(role.roleType).icon }} {{ role.name }}
            </option>
          </optgroup>
          <optgroup label="Provider Roles" *ngIf="canAssignProviderRoles()">
            <option *ngFor="let role of getProviderRoles()" [value]="role._id">
              {{ getRoleInfo(role.roleType).icon }} {{ role.name }}
            </option>
          </optgroup>
        </select>
        <p class="form-hint">Choose the appropriate role based on user responsibilities</p>
      </div>

      <div class="form-group">
        <label for="applicationId" class="form-label">
          Application Context
          <span class="required">*</span>
        </label>
        <input
          id="applicationId"
          type="text"
          formControlName="applicationId"
          placeholder="Enter application or project ID"
          class="form-control">
        <p class="form-hint">Scope the role to a specific application or project</p>
      </div>

      <div class="form-group">
        <label for="expiresAt" class="form-label">
          Expiration Date
          <span class="optional">(Optional)</span>
        </label>
        <input
          id="expiresAt"
          type="date"
          formControlName="expiresAt"
          class="form-control">
        <p class="form-hint">Leave empty for permanent assignment</p>
      </div>
    </form>

    <div class="modal-footer">
      <button type="button" class="btn btn-outline" (click)="closeAssignModal()">
        Cancel
      </button>
      <button type="submit" class="btn btn-primary" (click)="assignRole()"
              [disabled]="!assignRoleForm.valid">
        <svg class="btn-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path fill-rule="evenodd" d="M12.416 3.376a.75.75 0 01.208 1.04l-5 7.5a.75.75 0 01-1.154.114l-3-3a.75.75 0 011.06-1.06l2.353 2.353 4.493-6.74a.75.75 0 011.04-.207z" clip-rule="evenodd"/>
        </svg>
        Assign Role
      </button>
    </div>
  </div>
</div>
