<app-widget-menu></app-widget-menu>

<div class="widget-builder" id="main-content">
  <!-- Edit Mode Header -->
  <header class="builder-header" *ngIf="isEditing()">
    <div class="header-left">
      <h1>{{ selectedWidget()?.name }}</h1>
    </div>
    <div class="header-right">
      <button class="btn btn-outline" (click)="previewWidget()" title="Preview widget in new window">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
          <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
        </svg>
        Preview
      </button>
      <button class="btn btn-outline" (click)="openExportModal()">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M8 2a.5.5 0 01.5.5v8.793l3.146-3.147a.5.5 0 01.708.708l-4 4a.5.5 0 01-.708 0l-4-4a.5.5 0 11.708-.708L7.5 11.293V2.5A.5.5 0 018 2z"/>
          <path d="M14 9.5a.5.5 0 01.5.5v3a1 1 0 01-1 1H2a1 1 0 01-1-1v-3a.5.5 0 011 0v3h11v-3a.5.5 0 01.5-.5z"/>
        </svg>
        Export
      </button>
      <button class="btn btn-outline" (click)="exitEditMode()">
        ‚Üê Back to Widgets
      </button>
    </div>
  </header>

  <!-- List Mode Header -->
  <header class="builder-header" *ngIf="!isEditing()">
    <div class="header-left">
      <h1>Pricing Widgets</h1>
      <p class="header-subtitle">Create professional pricing widgets for your business</p>
    </div>
    <div class="header-right">
      <button class="btn btn-primary" (click)="createNewWidget()">
        + New Widget
      </button>
    </div>
  </header>

  <div class="builder-content">
    <main class="main-content">
      <!-- Edit Mode - Widget Canvas with Sidebar -->
      <div class="edit-mode" *ngIf="isEditing()">
        <div class="canvas-area">
          <app-canvas></app-canvas>
        </div>
        <aside class="right-sidebar">
          <div class="sidebar-section">
            <h3>
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 1a7 7 0 100 14A7 7 0 008 1zm0 12a5 5 0 110-10 5 5 0 010 10z"/>
                <path d="M8 4a4 4 0 100 8 4 4 0 000-8z"/>
              </svg>
              Theme
            </h3>
            <app-theme-switcher></app-theme-switcher>
          </div>

          <div class="sidebar-section">
            <h3>
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M1 3a1 1 0 011-1h12a1 1 0 011 1v10a1 1 0 01-1 1H2a1 1 0 01-1-1V3zm1 0v10h12V3H2z"/>
                <path d="M4 5h8v1H4zM4 7h6v1H4zM4 9h8v1H4z"/>
              </svg>
              Blocks
            </h3>
            <app-palette></app-palette>
          </div>

          <div class="sidebar-section">
            <h3>
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M1 4a1 1 0 011-1h12a1 1 0 011 1v8a1 1 0 01-1 1H2a1 1 0 01-1-1V4zm1 0v8h12V4H2z"/>
                <path d="M4 6h8v1H4zM4 8h6v1H4zM4 10h8v1H4z"/>
              </svg>
              Properties
            </h3>
            <app-properties-panel></app-properties-panel>
          </div>
        </aside>
      </div>

      <!-- List Mode - Templates and Widgets -->
      <section class="list-section" *ngIf="!isEditing()">
        <!-- Templates Section -->
        <section class="templates-section">
          <div class="section-header">
            <h2>Templates</h2>
            <p class="section-description">Choose from professionally designed templates to get started quickly</p>
          </div>
          <div class="templates-grid">
            <!-- Blank Template Card -->
            <div class="template-card blank-template"
                 (click)="createNewWidget()"
                 (keydown.enter)="createNewWidget()"
                 (keydown.space)="createNewWidget()"
                 tabindex="0"
                 role="button"
                 aria-label="Create blank widget from scratch">
              <div class="template-preview blank-preview">
                <div class="preview-placeholder">
                  <span>+</span>
                  <p>Start from scratch</p>
                </div>
              </div>
              <div class="template-info">
                <h3>Blank Widget</h3>
                <p>Create a custom widget from scratch</p>
                <button class="btn btn-primary" (click)="createNewWidget(); $event.stopPropagation()">
                  Create
                </button>
              </div>
            </div>

            <!-- Template Cards -->
            <div *ngFor="let template of templates()" class="template-card">
              <div class="template-preview">
                <app-template-thumbnail
                  [templateName]="template.name"
                  [templateType]="getTemplateType(template.name)"
                  [imageSrc]="getTemplateImage(template.name)">
                </app-template-thumbnail>
              </div>
              <div class="template-info">
                <h3>{{ template.name }}</h3>
                <p>{{ getTemplateDescription(template) }}</p>
                <button class="btn btn-primary" (click)="createFromTemplate(template.id); $event.stopPropagation()">
                  Create
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Widgets Section -->
        <section class="widgets-section" *ngIf="hasWidgets()">
          <div class="section-header">
            <h2>Your Widgets</h2>
            <p class="section-description">Manage and customize your existing pricing widgets</p>
          </div>
          <div class="widgets-grid">
            <div *ngFor="let widget of widgets()" class="widget-card">
              <div class="widget-preview">
                <div class="preview-content mini">
                  <div class="preview-columns" [style.grid-template-columns]="'repeat(' + widget.columns.length + ', 1fr)'">
                    <div *ngFor="let column of widget.columns" class="preview-column">
                      <div *ngFor="let block of column.blocks.slice(0, 2)"
                           class="preview-block mini"
                           [ngClass]="'preview-' + block.type">
                        {{ getBlockPreview(block.type) }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="widget-header">
                <h3>{{ widget.name }}</h3>
              </div>
              <div class="widget-details">
                <p>{{ widget.columns.length }} column{{ widget.columns.length !== 1 ? 's' : '' }},
                   {{ getColumnBlockCount(widget) }} block{{ getColumnBlockCount(widget) !== 1 ? 's' : '' }}</p>
              </div>
              <div class="widget-actions">
                <button class="btn btn-outline" (click)="selectWidget(widget.id)">
                  Edit
                </button>
                <button class="btn btn-secondary" (click)="previewWidgetById(widget.id)" title="Preview widget in new window">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                    <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                  </svg>
                  Preview
                </button>
                <button class="btn btn-danger" (click)="deleteWidgetById(widget.id)">
                  Delete
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Empty State -->
        <section class="empty-state" *ngIf="!hasWidgets()">
          <div class="empty-state-content">
            <div class="empty-icon">
              <svg width="64" height="64" viewBox="0 0 16 16" fill="currentColor">
                <path d="M1 3a1 1 0 011-1h12a1 1 0 011 1v10a1 1 0 01-1 1H2a1 1 0 01-1-1V3zm1 0v10h12V3H2z"/>
                <path d="M4 5h8v1H4zM4 7h6v1H4zM4 9h8v1H4z"/>
              </svg>
            </div>
            <h3>No widgets created yet</h3>
            <p>Select a template above to create your first professional pricing widget</p>
          </div>
        </section>
      </section>
    </main>
  </div>

  <app-export-modal
    *ngIf="showExportModal()"
    (closeModal)="closeExportModal()">
  </app-export-modal>
</div>
