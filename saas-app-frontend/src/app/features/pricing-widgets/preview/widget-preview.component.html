<div class="preview-container" [ngClass]="containerClass()" (keydown)="onKeyDown($event)" tabindex="0" data-testid="preview-container">
  <!-- Header Controls -->
  <header class="preview-header" *ngIf="!isFullscreen()">
    <div class="header-left">
      <button class="btn btn-outline" (click)="goBack()">
        ‚Üê Back to Builder
      </button>
      <h1 class="preview-title">Widget Preview</h1>
    </div>
    
    <div class="header-right">
      <!-- Payment Button - Only show if payment hasn't been processed -->
      <button 
        class="btn btn-success" 
        (click)="processPayment()" 
        *ngIf="!paymentProcessed() && currentWidgetId()"
        [disabled]="isLoading()">
        üí≥ Pay $5.00 to Preview
      </button>
      
      <button class="btn btn-outline" (click)="refreshPreview()" title="Refresh Preview (Ctrl+R)">
        üîÑ Refresh
      </button>
      <button class="btn btn-primary" (click)="toggleFullscreen()" title="Toggle Fullscreen (Ctrl+F)">
        üñ•Ô∏è Fullscreen
      </button>
    </div>
  </header>

  <!-- Payment Required Message -->
  <div class="payment-required" *ngIf="!paymentProcessed() && currentWidgetId()">
    <div class="payment-content">
      <h2>üîí Preview Access Required</h2>
      <p>To preview this widget, a one-time payment of $5.00 is required.</p>
      <button class="btn btn-success btn-lg" (click)="processPayment()" [disabled]="isLoading()">
        üí≥ Pay $5.00 to Unlock Preview
      </button>
      <p class="payment-note">This is a demo implementation. In a production environment, pricing would be configurable per widget.</p>
    </div>
  </div>

  <!-- Device Toggle Controls -->
  <div class="device-controls" *ngIf="showDeviceToggle() && paymentProcessed()" data-testid="device-controls">
    <div class="device-toggle">
      <h3>Device Preview</h3>
      <div class="device-buttons">
        <button 
          *ngFor="let device of deviceSizes()" 
          class="device-btn"
          [class.device-btn--active]="isCurrentDeviceSize(device)"
          (click)="setDeviceSize(device)"
          [title]="getDeviceDescription(device)">
          <span class="device-icon">{{ getDeviceIcon(device) }}</span>
          <span class="device-name">{{ device.name }}</span>
          <span class="device-size">{{ device.width }}px</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Template Switcher -->
  <div class="template-switcher" *ngIf="showTemplateSwitcher() && paymentProcessed()" data-testid="template-switcher">
    <div class="template-controls">
      <h3>Live Templates</h3>
      <div class="template-list">
        <button 
          *ngFor="let template of availableTemplates$()" 
          class="template-btn"
          (click)="switchToTemplate(template.id)"
          [title]="getTemplateTemplateDescription(template)">
          <span class="template-name">{{ getTemplateTemplateName(template) }}</span>
          <span class="template-info">{{ getTemplateTemplateDescription(template) }}</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading()">
    <div class="loading-spinner"></div>
    <p>Loading widget preview...</p>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="error()">
    <div class="error-content">
      <h3>Preview Error</h3>
      <p>{{ error() }}</p>
      <button class="btn btn-primary" (click)="refreshPreview()">Retry</button>
    </div>
  </div>

  <!-- Preview Frame - Only show after payment -->
  <div class="preview-frame-container" *ngIf="paymentProcessed() && !isLoading() && !error()" data-testid="preview-frame">
    <div class="preview-frame" [style]="previewFrameStyle()">
      <div class="preview-content" [innerHTML]="previewHtml()"></div>
    </div>
    
    <!-- Device Frame Overlay -->
    <div class="device-frame" *ngIf="!isFullscreen()">
      <div class="device-frame-header">
        <span class="device-frame-title">{{ getCurrentDeviceSize().name }} Preview</span>
        <span class="device-frame-size">{{ getCurrentDeviceSize().width }} √ó {{ getCurrentDeviceSize().height }}</span>
      </div>
    </div>
  </div>

  <!-- Fullscreen Controls -->
  <div class="fullscreen-controls" *ngIf="isFullscreen() && paymentProcessed()">
    <button class="btn btn-outline fullscreen-exit" (click)="toggleFullscreen()">
      ‚úï Exit Fullscreen
    </button>
  </div>

  <!-- Keyboard Shortcuts Help -->
  <div class="shortcuts-help" *ngIf="!isFullscreen() && paymentProcessed()">
    <div class="shortcuts-content">
      <h4>Keyboard Shortcuts</h4>
      <ul>
        <li><kbd>Ctrl + F</kbd> Toggle Fullscreen</li>
        <li><kbd>Ctrl + R</kbd> Refresh Preview</li>
        <li><kbd>Esc</kbd> Exit Fullscreen</li>
      </ul>
    </div>
  </div>
</div>